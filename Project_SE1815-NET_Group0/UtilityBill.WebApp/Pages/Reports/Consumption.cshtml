@page
@model UtilityBill.WebApp.Pages.Reports.ConsumptionModel
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
}

<h2 class="mb-4 text-center text-primary">Báo cáo tiêu thụ</h2>

<div class="container">
    <form id="filter-form" class="row g-3 p-4 border rounded shadow-sm mb-4 bg-light">
        <div class="col-md-3">
            <label class="form-label">Từ ngày</label>
            <input type="date" name="from" class="form-control" required />
        </div>
        <div class="col-md-3">
            <label class="form-label">Đến ngày</label>
            <input type="date" name="to" class="form-control" required />
        </div>
        <div class="col-md-3">
            <label class="form-label">Nhóm theo</label>
            <select name="groupBy" class="form-select">
                <option value="day">Theo ngày</option>
                <option value="month">Theo tháng</option>
                <option value="year">Theo năm</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end gap-2">
            <button type="submit" class="btn btn-primary w-100">Lọc dữ liệu</button>
            <button id="export-consumption" class="btn btn-outline-secondary w-100">Xuất Excel</button>
        </div>
    </form>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Biểu đồ tiêu thụ điện & nước</h5>
        </div>
        <div class="card-body">
            <canvas id="consumptionChart" style="height: 500px;"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const apiBase = '@Configuration["ApiBaseUrl"]';

        const consumptionChart = new Chart(document.getElementById('consumptionChart'), {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Số lượng tiêu thụ'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Thời gian'
                        }
                    }
                }
            }
        });

        $('#filter-form').on('submit', function (e) {
            e.preventDefault();
            const form = $(this);
            const params = form.serialize();

            $.getJSON(`${apiBase}/reports/consumption?${params}`, function (data) {
                const labels = data.map(x => x.period);
                const electric = data.map(x => x.totalElectric);
                const water = data.map(x => x.totalWater);

                consumptionChart.data = {
                    labels: labels,
                    datasets: [
                        { label: 'Điện (kWh)', backgroundColor: '#42a5f5', data: electric },
                        { label: 'Nước (m³)', backgroundColor: '#66bb6a', data: water }
                    ]
                };
                consumptionChart.update();
            });
        });

        $('#export-consumption').on('click', function (e) {
            e.preventDefault();
            const query = $('#filter-form').serialize();
            window.location = `${apiBase}/reports/export-consumption?${query}`;
        });

        $(function () {
            const today = new Date().toISOString().slice(0, 10);
            $('input[name="from"]').val(today);
            $('input[name="to"]').val(today);
            $('#filter-form').submit();
        });
    </script>
}
